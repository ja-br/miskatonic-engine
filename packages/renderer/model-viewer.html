<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-eval'; style-src 'self' 'unsafe-inline'"
    />
    <title>Miskatonic Model Viewer</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue',
          Arial, sans-serif;
        background: #000000;
        color: #ffffff;
        overflow: hidden;
      }

      #app {
        width: 100vw;
        height: 100vh;
        position: relative;
      }

      #canvas {
        width: 100%;
        height: 100%;
        display: block;
      }

      #stats {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.8);
        padding: 12px;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        font-size: 13px;
        line-height: 1.6;
        min-width: 200px;
      }

      #stats div {
        margin-bottom: 4px;
      }

      #stats div:last-child {
        margin-bottom: 0;
      }

      .stat-label {
        color: #888;
      }

      .stat-value {
        color: #0f0;
        font-weight: bold;
      }

      #info {
        position: absolute;
        bottom: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.8);
        padding: 12px;
        border-radius: 4px;
        font-size: 13px;
        font-family: 'Courier New', monospace;
      }

      #info div {
        margin-bottom: 6px;
      }

      #info div:last-child {
        margin-bottom: 0;
      }

      .key {
        display: inline-block;
        background: #333;
        padding: 2px 8px;
        border-radius: 3px;
        font-weight: bold;
        margin-right: 6px;
      }

      .title {
        font-size: 16px;
        font-weight: bold;
        color: #0f0;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      #controls {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.8);
        padding: 12px;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        font-size: 13px;
        min-width: 220px;
      }

      #controls .title {
        margin-bottom: 12px;
      }

      .control-group {
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px solid #333;
      }

      .control-group:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
      }

      .control-label {
        display: block;
        color: #888;
        margin-bottom: 6px;
        font-size: 11px;
        text-transform: uppercase;
      }

      .control-row {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
      }

      .control-row:last-child {
        margin-bottom: 0;
      }

      .control-row label {
        flex: 1;
        cursor: pointer;
      }

      .control-row input[type="checkbox"] {
        margin-right: 8px;
        cursor: pointer;
      }

      .control-row input[type="range"] {
        flex: 1;
        margin-left: 8px;
      }

      .slider-value {
        width: 40px;
        text-align: right;
        color: #0f0;
        font-size: 11px;
      }

      select {
        width: 100%;
        padding: 6px 8px;
        background: #222;
        color: #fff;
        border: 1px solid #444;
        border-radius: 3px;
        font-family: inherit;
        font-size: 12px;
        cursor: pointer;
      }

      select:hover {
        border-color: #0f0;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <canvas id="canvas"></canvas>

      <div id="stats">
        <div class="title">Model Viewer</div>
        <div id="fps-counter">-- FPS</div>
        <div id="vertex-count">Vertices: --</div>
        <div id="triangle-count">Triangles: --</div>
        <div id="vram-usage">VRAM: --</div>
      </div>

      <div id="controls">
        <div class="title">Controls</div>

        <div class="control-group">
          <span class="control-label">Model</span>
          <select id="model-select">
            <option value="/models/Naked Snake/Naked_Snake.obj">Naked Snake</option>
            <option value="sphere">Generated Sphere</option>
            <option value="cube">Generated Cube</option>
          </select>
        </div>

        <div class="control-group">
          <span class="control-label">Post-Processing</span>
          <div class="control-row">
            <input type="checkbox" id="bloom-toggle" checked>
            <label for="bloom-toggle">Bloom</label>
          </div>
          <div class="control-row">
            <span>Intensity</span>
            <input type="range" id="bloom-intensity" min="0" max="2" step="0.1" value="0.5">
            <span class="slider-value" id="bloom-intensity-value">0.5</span>
          </div>
        </div>

        <div class="control-group">
          <div class="control-row">
            <input type="checkbox" id="crt-toggle">
            <label for="crt-toggle">CRT Effect</label>
          </div>
          <div class="control-row">
            <span>Grain</span>
            <input type="range" id="grain-amount" min="0" max="0.1" step="0.01" value="0.02">
            <span class="slider-value" id="grain-value">0.02</span>
          </div>
        </div>

        <div class="control-group">
          <span class="control-label">Lighting</span>
          <div class="control-row">
            <span>Intensity</span>
            <input type="range" id="light-intensity" min="0" max="3" step="0.1" value="1.2">
            <span class="slider-value" id="light-intensity-value">1.2</span>
          </div>
        </div>
      </div>

      <div id="info">
        <div><span class="key">LMB Drag</span> Orbit camera</div>
        <div><span class="key">Scroll</span> Zoom in/out</div>
        <div><span class="key">Q/↑</span> Raise view target</div>
        <div><span class="key">E/↓</span> Lower view target</div>
        <div><span class="key">R</span> Reset camera</div>
        <div style="margin-top: 12px; padding-top: 8px; border-top: 1px solid #444;">
          <a href="/index.html" style="color: #0f0; text-decoration: none;">← Back to Main Demo</a>
        </div>
      </div>
    </div>

    <script type="module">
      import { ModelViewer } from './src/model-viewer.ts';

      const canvas = document.getElementById('canvas');
      const viewer = new ModelViewer(canvas);

      async function init() {
        const success = await viewer.initialize();
        if (success) {
          viewer.start();
          console.log('Model Viewer started');
          setupControls();
        } else {
          console.error('Failed to initialize Model Viewer');
        }
      }

      function setupControls() {
        // Model selection
        const modelSelect = document.getElementById('model-select');
        modelSelect.addEventListener('change', async (e) => {
          await viewer.loadModelByPath(e.target.value);
        });

        // Bloom toggle
        const bloomToggle = document.getElementById('bloom-toggle');
        bloomToggle.addEventListener('change', (e) => {
          viewer.setBloomEnabled(e.target.checked);
        });

        // Bloom intensity
        const bloomIntensity = document.getElementById('bloom-intensity');
        const bloomIntensityValue = document.getElementById('bloom-intensity-value');
        bloomIntensity.addEventListener('input', (e) => {
          const value = parseFloat(e.target.value);
          bloomIntensityValue.textContent = value.toFixed(1);
          viewer.setBloomIntensity(value);
        });

        // CRT toggle
        const crtToggle = document.getElementById('crt-toggle');
        crtToggle.addEventListener('change', (e) => {
          viewer.setCRTEnabled(e.target.checked);
        });

        // Film grain
        const grainAmount = document.getElementById('grain-amount');
        const grainValue = document.getElementById('grain-value');
        grainAmount.addEventListener('input', (e) => {
          const value = parseFloat(e.target.value);
          grainValue.textContent = value.toFixed(2);
          viewer.setGrainAmount(value);
        });

        // Light intensity
        const lightIntensity = document.getElementById('light-intensity');
        const lightIntensityValue = document.getElementById('light-intensity-value');
        lightIntensity.addEventListener('input', (e) => {
          const value = parseFloat(e.target.value);
          lightIntensityValue.textContent = value.toFixed(1);
          viewer.setLightIntensity(value);
        });
      }

      init();

      // Cleanup on page unload
      window.addEventListener('beforeunload', () => {
        viewer.stop();
      });
    </script>
  </body>
</html>
